<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Kas QC Shift B</title>
  
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            'dark-void': '#0A0A0E', // Sangat gelap untuk latar belakang utama
            'deep-space': '#1A1A2E', // Biru gelap keunguan untuk latar belakang sekunder
            'electric-blue': '#00ADB5', // Biru terang-cyan untuk aksen utama/tombol
            'cyber-purple': '#BB86FC', // Ungu terang untuk aksen sekunder
            'neon-green': '#00F5D4', // Hijau neon untuk highlight/sukses
            'light-ghost': '#EEEEEE', // Abu-abu terang untuk teks/konten
            'warm-red': '#CF6679', // Merah untuk error/peringatan
          }
        }
      }
    }
  </script>
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap');
    
    body {
      font-family: 'Poppins', sans-serif;
      @apply bg-dark-void text-light-ghost; /* Menggunakan warna baru */
    }
    .modal {
      @apply bg-deep-space; /* Warna latar belakang modal */
    }
    .modal-content {
      @apply bg-deep-space; /* Warna konten modal */
    }
    .btn-primary {
      @apply bg-electric-blue hover:bg-opacity-80 text-dark-void; /* Tombol utama */
    }
    .btn-secondary {
      @apply bg-cyber-purple hover:bg-opacity-80 text-dark-void; /* Tombol sekunder */
    }
    .btn-danger {
      @apply bg-warm-red hover:bg-opacity-80 text-light-ghost; /* Tombol bahaya */
    }
    input, textarea, select {
      @apply bg-deep-space border border-electric-blue/50 text-light-ghost focus:ring-electric-blue focus:border-electric-blue;
    }
    .header {
      @apply bg-deep-space shadow-lg;
    }
    .nav-link {
      @apply text-light-ghost hover:text-electric-blue;
    }
    .admin-panel-bg {
      @apply bg-deep-space;
    }
    .card {
      @apply bg-deep-space shadow-md border border-electric-blue/20;
    }
    .stat-card {
      @apply bg-deep-space shadow-md border border-neon-green/20;
    }
    /* Menyesuaikan warna notifikasi */
    .toast.bg-green-500 { @apply bg-neon-green text-dark-void; }
    .toast.bg-red-500 { @apply bg-warm-red text-light-ghost; }
    .toast.bg-blue-500 { @apply bg-electric-blue text-dark-void; }
    
    /* Scrollbar Styling for a futuristic look */
    ::-webkit-scrollbar {
      width: 8px;
    }
    ::-webkit-scrollbar-track {
      background: #1A1A2E; /* deep-space */
    }
    ::-webkit-scrollbar-thumb {
      background: #00ADB5; /* electric-blue */
      border-radius: 4px;
    }
    ::-webkit-scrollbar-thumb:hover {
      background: #008C90; /* slightly darker electric-blue on hover */
    }

  </style>
</head>
<body class="bg-dark-void text-light-ghost min-h-screen flex flex-col">
  
  <section id="loginSection" class="flex flex-col items-center justify-center min-h-screen p-4 bg-deep-space">
    <div class="bg-dark-void p-8 rounded-lg shadow-xl w-full max-w-md border border-electric-blue/30">
      <h2 class="text-3xl font-bold text-light-ghost mb-6 text-center">Login Kas QC</h2>
      <div class="mb-4">
        <label for="email" class="block text-light-ghost text-sm font-bold mb-2">Email</label>
        <input type="email" id="email" class="shadow appearance-none border rounded w-full py-3 px-4 text-dark-void leading-tight focus:outline-none focus:shadow-outline bg-deep-space border-electric-blue/50 text-light-ghost" placeholder="email@example.com">
      </div>
      <div class="mb-6">
        <label for="password" class="block text-light-ghost text-sm font-bold mb-2">Password</label>
        <input type="password" id="password" class="shadow appearance-none border rounded w-full py-3 px-4 text-dark-void leading-tight focus:outline-none focus:shadow-outline bg-deep-space border-electric-blue/50 text-light-ghost" placeholder="********">
      </div>
      <div class="flex items-center justify-between mb-4">
        <button id="loginButton" class="bg-electric-blue hover:bg-opacity-80 text-dark-void font-bold py-3 px-6 rounded-lg focus:outline-none focus:shadow-outline transition duration-200">
          Login
        </button>
        <a href="#" id="forgotPasswordLink" class="inline-block align-baseline font-bold text-sm text-electric-blue hover:text-cyber-purple">
          Lupa password?
        </a>
      </div>
      <p class="text-center text-light-ghost text-sm">
        Belum punya akun? <a href="#" id="registerLink" class="text-electric-blue hover:text-cyber-purple font-bold">Daftar</a>
      </p>
      <div id="loginMessage" class="mt-4 text-center text-sm font-semibold"></div>
    </div>
  </section>

  <div id="registerModal" class="fixed inset-0 bg-dark-void bg-opacity-75 flex items-center justify-center hidden z-50">
    <div class="bg-deep-space p-8 rounded-lg shadow-xl w-full max-w-md border border-electric-blue/30">
      <h3 class="text-2xl font-bold text-light-ghost mb-6 text-center">Daftar Akun Baru</h3>
      <div class="mb-4">
        <label for="registerEmail" class="block text-light-ghost text-sm font-bold mb-2">Email</label>
        <input type="email" id="registerEmail" class="shadow appearance-none border rounded w-full py-3 px-4 text-dark-void leading-tight focus:outline-none focus:shadow-outline bg-dark-void border-electric-blue/50 text-light-ghost" placeholder="email@example.com">
      </div>
      <div class="mb-4">
        <label for="registerPassword" class="block text-light-ghost text-sm font-bold mb-2">Password</label>
        <input type="password" id="registerPassword" class="shadow appearance-none border rounded w-full py-3 px-4 text-dark-void leading-tight focus:outline-none focus:shadow-outline bg-dark-void border-electric-blue/50 text-light-ghost" placeholder="********">
      </div>
      <div class="mb-6">
        <label for="confirmPassword" class="block text-light-ghost text-sm font-bold mb-2">Konfirmasi Password</label>
        <input type="password" id="confirmPassword" class="shadow appearance-none border rounded w-full py-3 px-4 text-dark-void leading-tight focus:outline-none focus:shadow-outline bg-dark-void border-electric-blue/50 text-light-ghost" placeholder="********">
      </div>
      <div class="flex items-center justify-between">
        <button id="submitRegister" class="bg-electric-blue hover:bg-opacity-80 text-dark-void font-bold py-3 px-6 rounded-lg focus:outline-none focus:shadow-outline transition duration-200">
          Daftar
        </button>
        <button id="closeRegisterModal" class="bg-warm-red hover:bg-opacity-80 text-light-ghost font-bold py-3 px-6 rounded-lg focus:outline-none focus:shadow-outline transition duration-200">
          Batal
        </button>
      </div>
      <div id="registerMessage" class="mt-4 text-center text-sm font-semibold"></div>
    </div>
  </div>

  <div id="appContainer" class="hidden flex-1 flex flex-col">
    <header class="bg-deep-space shadow-lg p-4 flex justify-between items-center z-10">
      <h1 class="text-2xl font-bold text-light-ghost">Kas QC Shift B</h1>
      <div class="relative dropdown">
        <img id="currentUserAvatar" src="https://i.pravatar.cc/40?u=user@example.com" alt="User Avatar" class="w-10 h-10 rounded-full cursor-pointer border-2 border-electric-blue">
        <div class="dropdown-menu absolute right-0 mt-2 w-48 bg-dark-void rounded-md shadow-lg py-1 hidden z-20">
          <a href="#" id="profileLink" class="block px-4 py-2 text-sm text-light-ghost hover:bg-deep-space">Profil</a>
          <a href="#" id="logoutButton" class="block px-4 py-2 text-sm text-warm-red hover:bg-deep-space">Logout</a>
        </div>
      </div>
    </header>

    <main class="flex-1 p-6 overflow-auto">
      <nav id="adminNav" class="hidden mb-6">
        <ul class="flex space-x-4 bg-deep-space p-4 rounded-lg shadow-md">
          <li><a href="#" id="dashboardLink" class="nav-link text-lg font-semibold px-4 py-2 rounded-md hover:bg-electric-blue hover:text-dark-void transition duration-200">Dashboard</a></li>
          <li><a href="#" id="dataEntryLink" class="nav-link text-lg font-semibold px-4 py-2 rounded-md hover:bg-electric-blue hover:text-dark-void transition duration-200">Input Data</a></li>
          <li><a href="#" id="adminPanelLink" class="nav-link text-lg font-semibold px-4 py-2 rounded-md hover:bg-electric-blue hover:text-dark-void transition duration-200">Manajemen Pengguna</a></li>
        </ul>
      </nav>

      <section id="dashboardSection" class="active-section">
        <h2 class="text-3xl font-bold text-electric-blue mb-6">Dashboard</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
          <div class="stat-card p-6 rounded-lg text-center">
            <h3 class="text-xl font-semibold text-light-ghost mb-2">Total Transaksi</h3>
            <p id="totalTransactions" class="text-4xl font-bold text-neon-green">0</p>
          </div>
          <div class="stat-card p-6 rounded-lg text-center">
            <h3 class="text-xl font-semibold text-light-ghost mb-2">Pemasukan</h3>
            <p id="totalIncome" class="text-4xl font-bold text-neon-green">Rp 0</p>
          </div>
          <div class="stat-card p-6 rounded-lg text-center">
            <h3 class="text-xl font-semibold text-light-ghost mb-2">Pengeluaran</h3>
            <p id="totalExpense" class="text-4xl font-bold text-warm-red">Rp 0</p>
          </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <div class="card p-6 rounded-lg">
            <h3 class="text-xl font-semibold text-light-ghost mb-4">Grafik Transaksi Harian</h3>
            <canvas id="dailyTransactionChart"></canvas>
          </div>
          <div class="card p-6 rounded-lg">
            <h3 class="text-xl font-semibold text-light-ghost mb-4">Grafik Pemasukan vs Pengeluaran</h3>
            <canvas id="incomeExpenseChart"></canvas>
          </div>
        </div>
      </section>

      <section id="dataEntrySection" class="hidden">
        <h2 class="text-3xl font-bold text-electric-blue mb-6">Input Data Transaksi</h2>
        <div class="card p-6 rounded-lg w-full max-w-2xl mx-auto">
          <div class="mb-4">
            <label for="transactionType" class="block text-light-ghost text-sm font-bold mb-2">Jenis Transaksi</label>
            <select id="transactionType" class="shadow border rounded w-full py-3 px-4 text-dark-void leading-tight focus:outline-none focus:shadow-outline bg-deep-space border-electric-blue/50 text-light-ghost">
              <option value="pemasukan">Pemasukan</option>
              <option value="pengeluaran">Pengeluaran</option>
            </select>
          </div>
          <div class="mb-4">
            <label for="description" class="block text-light-ghost text-sm font-bold mb-2">Deskripsi</label>
            <textarea id="description" class="shadow appearance-none border rounded w-full py-3 px-4 text-dark-void leading-tight focus:outline-none focus:shadow-outline bg-deep-space border-electric-blue/50 text-light-ghost" placeholder="Deskripsi transaksi"></textarea>
          </div>
          <div class="mb-4">
            <label for="amount" class="block text-light-ghost text-sm font-bold mb-2">Jumlah (Rp)</label>
            <input type="number" id="amount" class="shadow appearance-none border rounded w-full py-3 px-4 text-dark-void leading-tight focus:outline-none focus:shadow-outline bg-deep-space border-electric-blue/50 text-light-ghost" placeholder="100000">
          </div>
          <div class="flex justify-end">
            <button id="addTransactionButton" class="bg-electric-blue hover:bg-opacity-80 text-dark-void font-bold py-3 px-6 rounded-lg focus:outline-none focus:shadow-outline transition duration-200">
              Tambah Transaksi
            </button>
          </div>
          <div id="dataEntryMessage" class="mt-4 text-center text-sm font-semibold"></div>
        </div>

        <h3 class="text-2xl font-bold text-light-ghost mt-8 mb-4">Daftar Transaksi</h3>
        <div class="overflow-x-auto card p-6 rounded-lg">
          <table class="min-w-full leading-normal">
            <thead>
              <tr class="bg-deep-space">
                <th class="px-5 py-3 border-b-2 border-electric-blue/30 text-left text-xs font-semibold text-light-ghost uppercase tracking-wider">
                  Tanggal
                </th>
                <th class="px-5 py-3 border-b-2 border-electric-blue/30 text-left text-xs font-semibold text-light-ghost uppercase tracking-wider">
                  Jenis
                </th>
                <th class="px-5 py-3 border-b-2 border-electric-blue/30 text-left text-xs font-semibold text-light-ghost uppercase tracking-wider">
                  Deskripsi
                </th>
                <th class="px-5 py-3 border-b-2 border-electric-blue/30 text-left text-xs font-semibold text-light-ghost uppercase tracking-wider">
                  Jumlah (Rp)
                </th>
                <th class="px-5 py-3 border-b-2 border-electric-blue/30 text-left text-xs font-semibold text-light-ghost uppercase tracking-wider">
                  Aksi
                </th>
              </tr>
            </thead>
            <tbody id="transactionsTableBody">
              </tbody>
          </table>
          <div id="transactionsPagination" class="flex justify-center mt-4">
            <button id="prevTransactionsPage" class="bg-deep-space text-electric-blue px-4 py-2 rounded-l-md hover:bg-electric-blue hover:text-dark-void disabled:opacity-50 disabled:cursor-not-allowed">
              <i class="fas fa-chevron-left"></i>
            </button>
            <span id="currentTransactionsPage" class="bg-deep-space text-light-ghost px-4 py-2">1</span>
            <button id="nextTransactionsPage" class="bg-deep-space text-electric-blue px-4 py-2 rounded-r-md hover:bg-electric-blue hover:text-dark-void disabled:opacity-50 disabled:cursor-not-allowed">
              <i class="fas fa-chevron-right"></i>
            </button>
          </div>
        </div>
      </section>

      <section id="adminPanelSection" class="hidden admin-panel-bg p-6 rounded-lg shadow-md">
        <h2 class="text-3xl font-bold text-electric-blue mb-6">Manajemen Pengguna</h2>
        <div class="mb-4 flex space-x-4">
          <input type="text" id="newAdminEmail" class="shadow appearance-none border rounded py-3 px-4 text-dark-void leading-tight focus:outline-none focus:shadow-outline bg-deep-space border-electric-blue/50 text-light-ghost flex-grow" placeholder="Email admin baru">
          <button id="addAdminButton" class="bg-electric-blue hover:bg-opacity-80 text-dark-void font-bold py-3 px-6 rounded-lg focus:outline-none focus:shadow-outline transition duration-200">
            Tambah Admin
          </button>
        </div>
        <div id="adminMessage" class="mt-4 text-center text-sm font-semibold"></div>

        <h3 class="text-2xl font-bold text-light-ghost mt-8 mb-4">Daftar Pengguna</h3>
        <div class="overflow-x-auto card p-6 rounded-lg">
          <table class="min-w-full leading-normal">
            <thead>
              <tr class="bg-deep-space">
                <th class="px-5 py-3 border-b-2 border-electric-blue/30 text-left text-xs font-semibold text-light-ghost uppercase tracking-wider">
                  Email
                </th>
                <th class="px-5 py-3 border-b-2 border-electric-blue/30 text-left text-xs font-semibold text-light-ghost uppercase tracking-wider">
                  Role
                </th>
                <th class="px-5 py-3 border-b-2 border-electric-blue/30 text-left text-xs font-semibold text-light-ghost uppercase tracking-wider">
                  Aksi
                </th>
              </tr>
            </thead>
            <tbody id="usersTableBody">
              </tbody>
          </table>
          <div id="usersPagination" class="flex justify-center mt-4">
            <button id="prevUsersPage" class="bg-deep-space text-electric-blue px-4 py-2 rounded-l-md hover:bg-electric-blue hover:text-dark-void disabled:opacity-50 disabled:cursor-not-allowed">
              <i class="fas fa-chevron-left"></i>
            </button>
            <span id="currentUsersPage" class="bg-deep-space text-light-ghost px-4 py-2">1</span>
            <button id="nextUsersPage" class="bg-deep-space text-electric-blue px-4 py-2 rounded-r-md hover:bg-electric-blue hover:text-dark-void disabled:opacity-50 disabled:cursor-not-allowed">
              <i class="fas fa-chevron-right"></i>
            </button>
          </div>
        </div>
      </section>
      
      <div id="profileModal" class="fixed inset-0 bg-dark-void bg-opacity-75 flex items-center justify-center hidden z-50">
        <div class="bg-deep-space p-8 rounded-lg shadow-xl w-full max-w-md border border-electric-blue/30">
          <h3 class="text-2xl font-bold text-light-ghost mb-6 text-center">Profil Pengguna</h3>
          <div class="mb-4">
            <label for="profileEmail" class="block text-light-ghost text-sm font-bold mb-2">Email</label>
            <input type="email" id="profileEmail" class="shadow appearance-none border rounded w-full py-3 px-4 leading-tight focus:outline-none focus:shadow-outline bg-dark-void border-electric-blue/50 text-light-ghost" readonly>
          </div>
          <div class="mb-4">
            <label for="profilePassword" class="block text-light-ghost text-sm font-bold mb-2">Password Baru</label>
            <input type="password" id="profilePassword" class="shadow appearance-none border rounded w-full py-3 px-4 leading-tight focus:outline-none focus:shadow-outline bg-dark-void border-electric-blue/50 text-light-ghost" placeholder="Kosongkan jika tidak ingin mengubah">
          </div>
          <div class="flex items-center justify-between">
            <button id="updateProfileButton" class="bg-electric-blue hover:bg-opacity-80 text-dark-void font-bold py-3 px-6 rounded-lg focus:outline-none focus:shadow-outline transition duration-200">
              Update Profil
            </button>
            <button id="closeProfileModal" class="bg-warm-red hover:bg-opacity-80 text-light-ghost font-bold py-3 px-6 rounded-lg focus:outline-none focus:shadow-outline transition duration-200">
              Tutup
            </button>
          </div>
          <div id="profileMessage" class="mt-4 text-center text-sm font-semibold"></div>
        </div>
      </div>
    </main>

    <div id="toastContainer" class="fixed bottom-4 right-4 z-50 space-y-2"></div>
  </div>

  <script>
    // Supabase Client Initialization
    const supabaseUrl = 'https://aqlhsnkprwcxhqvizvyj.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFxbGhzbmtwcndjeGhxdml6dnlqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE5ODkzMDksImV4cCI6MjA2NzU2NTMwOX0.OKEP8UOnhhhbl3finjKkgybFeMFz09yEW_lxWnjoFCY';
    const supabase = Supabase.createClient(supabaseUrl, supabaseKey);

    let currentUserData = null;
    let transactionsChart = null;
    let incomeExpenseChart = null;

    // Pagination variables
    let currentTransactionsPage = 1;
    const transactionsPerPage = 10;
    let totalTransactionsCount = 0;

    let currentUsersPage = 1;
    const usersPerPage = 10;
    let totalUsersCount = 0;

// Utility function for showing toasts
    function showToast(message, type = 'success') {
      const toastContainer = document.getElementById('toastContainer');
      const toast = document.createElement('div');
      toast.className = `toast p-3 rounded-md shadow-lg text-sm transition-all duration-300 ease-in-out transform translate-x-full opacity-0`;
      
      let bgColorClass = '';
      if (type === 'success') {
        bgColorClass = 'bg-neon-green text-dark-void';
      } else if (type === 'error') {
        bgColorClass = 'bg-warm-red text-light-ghost';
      } else if (type === 'info') {
        bgColorClass = 'bg-electric-blue text-dark-void';
      }

      toast.classList.add(bgColorClass);
      toast.textContent = message;
      toastContainer.appendChild(toast);

      // Animate in
      setTimeout(() => {
        toast.classList.remove('translate-x-full', 'opacity-0');
        toast.classList.add('translate-x-0', 'opacity-100');
      }, 10); // Small delay to ensure transition applies

      // Animate out and remove
      setTimeout(() => {
        toast.classList.remove('translate-x-0', 'opacity-100');
        toast.classList.add('translate-x-full', 'opacity-0');
        toast.addEventListener('transitionend', () => toast.remove());
      }, 3000); // Toast disappears after 3 seconds
    }

    // SECTION MANAGEMENT
    function showSection(sectionId) {
      document.querySelectorAll('section').forEach(section => {
        section.classList.add('hidden');
        section.classList.remove('active-section');
      });
      document.getElementById(sectionId).classList.remove('hidden');
      document.getElementById(sectionId).classList.add('active-section');
    }

    // Event Listeners for Navigation
    document.getElementById('dashboardLink').addEventListener('click', (e) => {
      e.preventDefault();
      showSection('dashboardSection');
      loadDashboardData();
    });
    document.getElementById('dataEntryLink').addEventListener('click', (e) => {
      e.preventDefault();
      showSection('dataEntrySection');
      loadTransactions();
    });
    document.getElementById('adminPanelLink').addEventListener('click', (e) => {
      e.preventDefault();
      showSection('adminPanelSection');
      loadUsers();
    });
    document.getElementById('profileLink').addEventListener('click', (e) => {
      e.preventDefault();
      showProfileModal();
    });
    document.getElementById('logoutButton').addEventListener('click', async () => {
      const { error } = await supabase.auth.signOut();
      if (error) {
        showToast('Terjadi kesalahan saat logout: ' + error.message, 'error');
      } else {
        localStorage.removeItem('isAdmin');
        showToast('Berhasil logout', 'success');
        showSection('loginSection');
      }
    });

    // LOGIN & REGISTER
    document.getElementById('loginButton').addEventListener('click', async () => {
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      const loginMessage = document.getElementById('loginMessage');

      const { data, error } = await supabase.auth.signInWithPassword({ email, password });

      if (error) {
        loginMessage.textContent = 'Email atau password salah!';
        loginMessage.classList.add('text-warm-red');
        showToast('Login gagal: ' + error.message, 'error');
      } else {
        loginMessage.textContent = '';
        loginMessage.classList.remove('text-warm-red');
        showToast('Login berhasil!', 'success');
        // onAuthStateChange will handle UI update
      }
    });

    document.getElementById('registerLink').addEventListener('click', (e) => {
      e.preventDefault();
      document.getElementById('registerModal').classList.remove('hidden');
    });

    document.getElementById('closeRegisterModal').addEventListener('click', () => {
      document.getElementById('registerModal').classList.add('hidden');
      document.getElementById('registerEmail').value = '';
      document.getElementById('registerPassword').value = '';
      document.getElementById('confirmPassword').value = '';
      document.getElementById('registerMessage').textContent = '';
      document.getElementById('registerMessage').classList.remove('text-warm-red', 'text-neon-green');
    });

    document.getElementById('submitRegister').addEventListener('click', async () => {
      const email = document.getElementById('registerEmail').value;
      const password = document.getElementById('registerPassword').value;
      const confirmPassword = document.getElementById('confirmPassword').value;
      const registerMessage = document.getElementById('registerMessage');

      if (password !== confirmPassword) {
        registerMessage.textContent = 'Password tidak cocok!';
        registerMessage.classList.add('text-warm-red');
        return;
      }

      const { data, error } = await supabase.auth.signUp({
        email,
        password,
        options: {
          data: {
            full_name: email.split('@')[0], // Default name from email
            avatar_url: `https://i.pravatar.cc/40?u=${email}`
          }
        }
      });

      if (error) {
        registerMessage.textContent = 'Pendaftaran gagal: ' + error.message;
        registerMessage.classList.add('text-warm-red');
        showToast('Pendaftaran gagal: ' + error.message, 'error');
      } else {
        registerMessage.textContent = 'Pendaftaran berhasil! Silakan cek email Anda untuk verifikasi.';
        registerMessage.classList.add('text-neon-green');
        showToast('Pendaftaran berhasil! Cek email untuk verifikasi.', 'success');
        // Optional: close modal after a delay
        setTimeout(() => {
          document.getElementById('registerModal').classList.add('hidden');
          document.getElementById('registerEmail').value = '';
          document.getElementById('registerPassword').value = '';
          document.getElementById('confirmPassword').value = '';
          document.getElementById('registerMessage').textContent = '';
        }, 3000);
      }
    });

    document.getElementById('forgotPasswordLink').addEventListener('click', async (e) => {
      e.preventDefault();
      const email = prompt("Masukkan email Anda untuk reset password:");
      if (email) {
        const { error } = await supabase.auth.resetPasswordForEmail(email, {
          redirectTo: window.location.origin, // Redirect back to your app after reset
        });

        if (error) {
          showToast('Gagal mengirim link reset password: ' + error.message, 'error');
        } else {
          showToast('Link reset password telah dikirim ke email Anda.', 'success');
        }
      }
    });


    // PROFILE MANAGEMENT
    function showProfileModal() {
      document.getElementById('profileEmail').value = currentUserData.email;
      document.getElementById('profileModal').classList.remove('hidden');
      document.getElementById('profilePassword').value = ''; // Clear password field
      document.getElementById('profileMessage').textContent = '';
      document.getElementById('profileMessage').classList.remove('text-warm-red', 'text-neon-green');
    }

    document.getElementById('closeProfileModal').addEventListener('click', () => {
      document.getElementById('profileModal').classList.add('hidden');
    });

    document.getElementById('updateProfileButton').addEventListener('click', async () => {
      const newPassword = document.getElementById('profilePassword').value;
      const profileMessage = document.getElementById('profileMessage');

      if (newPassword) {
        const { data, error } = await supabase.auth.updateUser({ password: newPassword });

        if (error) {
          profileMessage.textContent = 'Gagal memperbarui password: ' + error.message;
          profileMessage.classList.add('text-warm-red');
          showToast('Gagal update password: ' + error.message, 'error');
        } else {
          profileMessage.textContent = 'Password berhasil diperbarui!';
          profileMessage.classList.add('text-neon-green');
          showToast('Password berhasil diupdate!', 'success');
          // Clear password field after success
          document.getElementById('profilePassword').value = '';
          // Close modal after a short delay
          setTimeout(() => {
            document.getElementById('profileModal').classList.add('hidden');
          }, 2000);
        }
      } else {
        profileMessage.textContent = 'Tidak ada perubahan yang dilakukan.';
        profileMessage.classList.add('text-info');
        showToast('Tidak ada perubahan', 'info');
        // Close modal if no changes
        setTimeout(() => {
          document.getElementById('profileModal').classList.add('hidden');
        }, 1000);
      }
    });

    // DATA ENTRY
    document.getElementById('addTransactionButton').addEventListener('click', async () => {
      const type = document.getElementById('transactionType').value;
      const description = document.getElementById('description').value;
      const amount = parseFloat(document.getElementById('amount').value);
      const dataEntryMessage = document.getElementById('dataEntryMessage');

      if (!description || isNaN(amount) || amount <= 0) {
        dataEntryMessage.textContent = 'Deskripsi dan Jumlah harus diisi dengan benar!';
        dataEntryMessage.classList.add('text-warm-red');
        showToast('Input tidak valid!', 'error');
        return;
      }

      const { data, error } = await supabase
        .from('transactions')
        .insert([{ type, description, amount, user_id: currentUserData.id }]);

      if (error) {
        dataEntryMessage.textContent = 'Gagal menambah transaksi: ' + error.message;
        dataEntryMessage.classList.add('text-warm-red');
        showToast('Gagal tambah transaksi: ' + error.message, 'error');
      } else {
        dataEntryMessage.textContent = 'Transaksi berhasil ditambahkan!';
        dataEntryMessage.classList.remove('text-warm-red');
        dataEntryMessage.classList.add('text-neon-green');
        showToast('Transaksi berhasil!', 'success');
        document.getElementById('description').value = '';
        document.getElementById('amount').value = '';
        loadTransactions(); // Reload transactions after adding
        loadDashboardData(); // Update dashboard stats
      }
    });

    // LOAD TRANSACTIONS
    async function loadTransactions() {
      const tbody = document.getElementById('transactionsTableBody');
      tbody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-light-ghost">Memuat transaksi...</td></tr>';
      
      const is_admin = localStorage.getItem('isAdmin') === 'true';
      let query = supabase.from('transactions').select('*', { count: 'exact' }).order('created_at', { ascending: false });

      if (!is_admin) {
          query = query.eq('user_id', currentUserData.id);
      }

      const { data, error, count } = await query
          .range((currentTransactionsPage - 1) * transactionsPerPage, currentTransactionsPage * transactionsPerPage - 1);

      if (error) {
        tbody.innerHTML = `<tr><td colspan="5" class="text-center py-4 text-warm-red">Gagal memuat transaksi: ${error.message}</td></tr>`;
        showToast('Gagal memuat transaksi: ' + error.message, 'error');
        return;
      }

      totalTransactionsCount = count;
      updateTransactionsPagination();

      tbody.innerHTML = ''; // Clear existing rows
      if (data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-light-ghost">Belum ada transaksi.</td></tr>';
      } else {
        data.forEach(transaction => {
          const row = tbody.insertRow();
          const date = new Date(transaction.created_at).toLocaleDateString('id-ID');
          const typeColorClass = transaction.type === 'pemasukan' ? 'text-neon-green' : 'text-warm-red';
          const amountFormatted = new Intl.NumberFormat('id-ID').format(transaction.amount);

          row.innerHTML = `
            <td class="px-5 py-5 border-b border-deep-space text-sm">${date}</td>
            <td class="px-5 py-5 border-b border-deep-space text-sm"><span class="${typeColorClass}">${transaction.type.toUpperCase()}</span></td>
            <td class="px-5 py-5 border-b border-deep-space text-sm">${transaction.description}</td>
            <td class="px-5 py-5 border-b border-deep-space text-sm">Rp ${amountFormatted}</td>
            <td class="px-5 py-5 border-b border-deep-space text-sm">
              <button data-id="${transaction.id}" class="delete-transaction-btn bg-warm-red hover:bg-opacity-80 text-light-ghost text-xs font-bold py-1 px-2 rounded-md transition duration-200">
                Hapus
              </button>
            </td>
          `;
        });

        // Add event listeners for delete buttons
        document.querySelectorAll('.delete-transaction-btn').forEach(button => {
          button.addEventListener('click', deleteTransaction);
        });
      }
    }

    async function deleteTransaction(event) {
        const transactionId = event.target.dataset.id;
        if (!confirm('Apakah Anda yakin ingin menghapus transaksi ini?')) {
            return;
        }

        const { error } = await supabase
            .from('transactions')
            .delete()
            .eq('id', transactionId);

        if (error) {
            showToast('Gagal menghapus transaksi: ' + error.message, 'error');
        } else {
            showToast('Transaksi berhasil dihapus!', 'success');
            loadTransactions(); // Reload the list
            loadDashboardData(); // Update dashboard stats
        }
    }

    function updateTransactionsPagination() {
      document.getElementById('currentTransactionsPage').textContent = currentTransactionsPage;
      const totalPages = Math.ceil(totalTransactionsCount / transactionsPerPage);

      document.getElementById('prevTransactionsPage').disabled = currentTransactionsPage === 1;
      document.getElementById('nextTransactionsPage').disabled = currentTransactionsPage >= totalPages;
    }

    document.getElementById('prevTransactionsPage').addEventListener('click', () => {
      if (currentTransactionsPage > 1) {
        currentTransactionsPage--;
        loadTransactions();
      }
    });

    document.getElementById('nextTransactionsPage').addEventListener('click', () => {
      const totalPages = Math.ceil(totalTransactionsCount / transactionsPerPage);
      if (currentTransactionsPage < totalPages) {
        currentTransactionsPage++;
        loadTransactions();
      }
    });


    // LOAD DASHBOARD DATA
    async function loadDashboardData() {
      const is_admin = localStorage.getItem('isAdmin') === 'true';
      let query = supabase.from('transactions').select('*');

      if (!is_admin) {
        query = query.eq('user_id', currentUserData.id);
      }
      
      const { data: transactions, error } = await query;

      if (error) {
        showToast('Gagal memuat data dashboard: ' + error.message, 'error');
        console.error('Error loading dashboard data:', error.message);
        return;
      }

      let totalIncome = 0;
      let totalExpense = 0;
      const dailyData = {}; // { 'YYYY-MM-DD': { income: 0, expense: 0, total: 0 } }

      transactions.forEach(t => {
        const date = new Date(t.created_at).toISOString().split('T')[0];
        if (!dailyData[date]) {
          dailyData[date] = { income: 0, expense: 0, total: 0 };
        }

        if (t.type === 'pemasukan') {
          totalIncome += t.amount;
          dailyData[date].income += t.amount;
          dailyData[date].total += t.amount;
        } else if (t.type === 'pengeluaran') {
          totalExpense += t.amount;
          dailyData[date].expense += t.amount;
          dailyData[date].total -= t.amount; // Negative for expense in total
        }
      });

      document.getElementById('totalTransactions').textContent = transactions.length;
      document.getElementById('totalIncome').textContent = `Rp ${new Intl.NumberFormat('id-ID').format(totalIncome)}`;
      document.getElementById('totalExpense').textContent = `Rp ${new Intl.NumberFormat('id-ID').format(totalExpense)}`;

      // Update Charts
      updateDailyTransactionChart(dailyData);
      updateIncomeExpenseChart(totalIncome, totalExpense);
    }

    function updateDailyTransactionChart(dailyData) {
      const labels = Object.keys(dailyData).sort();
      const dataPoints = labels.map(label => dailyData[label].total);

      if (transactionsChart) {
        transactionsChart.destroy();
      }

      const ctx = document.getElementById('dailyTransactionChart').getContext('2d');
      transactionsChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'Total Harian',
            data: dataPoints,
            borderColor: '#00ADB5', // electric-blue
            backgroundColor: 'rgba(0, 173, 181, 0.2)',
            tension: 0.3,
            fill: true
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              labels: {
                color: '#EEEEEE' // light-ghost
              }
            }
          },
          scales: {
            x: {
              grid: {
                color: 'rgba(26, 26, 46, 0.5)' // deep-space with transparency
              },
              ticks: {
                color: '#EEEEEE' // light-ghost
              }
            },
            y: {
              grid: {
                color: 'rgba(26, 26, 46, 0.5)' // deep-space with transparency
              },
              ticks: {
                color: '#EEEEEE' // light-ghost
              }
            }
          }
        }
      });
    }

    function updateIncomeExpenseChart(income, expense) {
      if (incomeExpenseChart) {
        incomeExpenseChart.destroy();
      }

      const ctx = document.getElementById('incomeExpenseChart').getContext('2d');
      incomeExpenseChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: ['Pemasukan', 'Pengeluaran'],
          datasets: [{
            data: [income, expense],
            backgroundColor: [
              '#00F5D4', // neon-green
              '#CF6679'  // warm-red
            ],
            hoverOffset: 4
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              labels: {
                color: '#EEEEEE' // light-ghost
              }
            }
          }
        }
      });
    }

    // ADMIN PANEL - USER MANAGEMENT
    async function loadUsers() {
      const tbody = document.getElementById('usersTableBody');
      tbody.innerHTML = '<tr><td colspan="3" class="text-center py-4 text-light-ghost">Memuat pengguna...</td></tr>';

      const { data, error, count } = await supabase
        .from('profiles')
        .select('id, email, role', { count: 'exact' })
        .order('created_at', { ascending: false })
        .range((currentUsersPage - 1) * usersPerPage, currentUsersPage * usersPerPage - 1);

      if (error) {
        tbody.innerHTML = `<tr><td colspan="3" class="text-center py-4 text-warm-red">Gagal memuat pengguna: ${error.message}</td></tr>`;
        showToast('Gagal memuat pengguna: ' + error.message, 'error');
        return;
      }

      totalUsersCount = count;
      updateUsersPagination();

      tbody.innerHTML = ''; // Clear existing rows
      if (data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="3" class="text-center py-4 text-light-ghost">Belum ada pengguna terdaftar.</td></tr>';
      } else {
        data.forEach(user => {
          const row = tbody.insertRow();
          const roleBadgeClass = user.role === 'admin' ? 'bg-electric-blue text-dark-void' : 'bg-cyber-purple text-dark-void';

          row.innerHTML = `
            <td class="px-5 py-5 border-b border-deep-space text-sm">${user.email}</td>
            <td class="px-5 py-5 border-b border-deep-space text-sm"><span class="px-2 py-1 rounded-full text-xs font-semibold ${roleBadgeClass}">${user.role.toUpperCase()}</span></td>
            <td class="px-5 py-5 border-b border-deep-space text-sm">
              ${user.email !== 'radiansyahhanif@gmail.com' ? `
                <button data-id="${user.id}" data-role="${user.role}" class="toggle-admin-btn bg-cyber-purple hover:bg-opacity-80 text-dark-void text-xs font-bold py-1 px-2 rounded-md mr-2 transition duration-200">
                  ${user.role === 'admin' ? 'Jadikan User' : 'Jadikan Admin'}
                </button>
                <button data-id="${user.id}" class="delete-user-btn bg-warm-red hover:bg-opacity-80 text-light-ghost text-xs font-bold py-1 px-2 rounded-md transition duration-200">
                  Hapus
                </button>
              ` : '<span class="text-light-ghost/70">Admin Utama</span>'}
            </td>
          `;
        });

        // Add event listeners for admin toggle and delete buttons
        document.querySelectorAll('.toggle-admin-btn').forEach(button => {
          button.addEventListener('click', toggleUserRole);
        });
        document.querySelectorAll('.delete-user-btn').forEach(button => {
          button.addEventListener('click', deleteUser);
        });
      }
    }

    async function toggleUserRole(event) {
        const userId = event.target.dataset.id;
        const currentRole = event.target.dataset.role;
        const newRole = currentRole === 'admin' ? 'user' : 'admin';

        if (!confirm(`Apakah Anda yakin ingin mengubah peran pengguna ini menjadi ${newRole}?`)) {
            return;
        }

        const { error } = await supabase
            .from('profiles')
            .update({ role: newRole })
            .eq('id', userId);

        if (error) {
            showToast('Gagal mengubah peran pengguna: ' + error.message, 'error');
        } else {
            showToast(`Peran pengguna berhasil diubah menjadi ${newRole}!`, 'success');
            loadUsers(); // Reload the user list
        }
    }

    async function deleteUser(event) {
        const userId = event.target.dataset.id;
        if (!confirm('Apakah Anda yakin ingin menghapus pengguna ini? Ini akan menghapus akun dan semua data terkait!')) {
            return;
        }

        // First, delete related transactions if any
        const { error: transactionsError } = await supabase
            .from('transactions')
            .delete()
            .eq('user_id', userId);

        if (transactionsError) {
            showToast('Gagal menghapus transaksi terkait pengguna: ' + transactionsError.message, 'error');
            return;
        }

        // Then, delete the user from profiles and auth.users
        const { error: profileError } = await supabase
            .from('profiles')
            .delete()
            .eq('id', userId);

        if (profileError) {
            showToast('Gagal menghapus profil pengguna: ' + profileError.message, 'error');
            return;
        }

        // Note: Deleting from auth.users might require Row Level Security on `auth.users` table
        // For simplicity and assuming admin has full access via service role or RLS allows for this,
        // we attempt to delete from auth.users directly. If RLS prevents it, this step might fail.
        // In a real application, you might use a Supabase Function (Edge Function) for this privileged operation.
        const { error: authUserError } = await supabase.rpc('delete_user_by_id', { user_id_to_delete: userId });

        if (authUserError) {
            // This error might happen if RLS on auth.users is too strict for direct client-side delete
            console.error('Gagal menghapus pengguna dari auth.users:', authUserError.message);
            showToast('Gagal menghapus pengguna sepenuhnya (auth.users): ' + authUserError.message + '. Mungkin perlu dihapus manual di dashboard Supabase.', 'error');
        } else {
            showToast('Pengguna berhasil dihapus!', 'success');
        }
        loadUsers(); // Reload the user list
    }

    function updateUsersPagination() {
      document.getElementById('currentUsersPage').textContent = currentUsersPage;
      const totalPages = Math.ceil(totalUsersCount / usersPerPage);

      document.getElementById('prevUsersPage').disabled = currentUsersPage === 1;
      document.getElementById('nextUsersPage').disabled = currentUsersPage >= totalPages;
    }

    document.getElementById('prevUsersPage').addEventListener('click', () => {
      if (currentUsersPage > 1) {
        currentUsersPage--;
        loadUsers();
      }
    });

    document.getElementById('nextUsersPage').addEventListener('click', () => {
      const totalPages = Math.ceil(totalUsersCount / usersPerPage);
      if (currentUsersPage < totalPages) {
        currentUsersPage++;
        loadUsers();
      }
    });

    document.getElementById('addAdminButton').addEventListener('click', async () => {
        const newAdminEmail = document.getElementById('newAdminEmail').value;
        const adminMessage = document.getElementById('adminMessage');

        if (!newAdminEmail) {
            adminMessage.textContent = 'Email tidak boleh kosong!';
            adminMessage.classList.add('text-warm-red');
            showToast('Email kosong!', 'error');
            return;
        }

        // First, check if user exists in auth.users or profiles
        const { data: userData, error: userError } = await supabase
            .from('profiles')
            .select('id, email')
            .eq('email', newAdminEmail)
            .single();

        if (userError && userError.code !== 'PGRST116') { // PGRST116 means no rows found
            adminMessage.textContent = 'Gagal mencari pengguna: ' + userError.message;
            adminMessage.classList.add('text-warm-red');
            showToast('Gagal mencari pengguna: ' + userError.message, 'error');
            return;
        }

        if (userData) {
            // User exists, just update role
            const { error: updateError } = await supabase
                .from('profiles')
                .update({ role: 'admin' })
                .eq('id', userData.id);
            
            if (updateError) {
                adminMessage.textContent = 'Gagal menjadikan admin: ' + updateError.message;
                adminMessage.classList.add('text-warm-red');
                showToast('Gagal menjadikan admin: ' + updateError.message, 'error');
            } else {
                adminMessage.textContent = `${newAdminEmail} berhasil dijadikan admin!`;
                adminMessage.classList.remove('text-warm-red');
                adminMessage.classList.add('text-neon-green');
                showToast('Berhasil dijadikan admin!', 'success');
                document.getElementById('newAdminEmail').value = '';
                loadUsers();
            }
        } else {
            // User does not exist, need to invite them
            const { data: inviteData, error: inviteError } = await supabase.auth.admin.inviteUserByEmail(newAdminEmail);

            if (inviteError) {
                adminMessage.textContent = 'Gagal mengundang pengguna baru: ' + inviteError.message;
                adminMessage.classList.add('text-warm-red');
                showToast('Gagal mengundang pengguna: ' + inviteError.message, 'error');
            } else {
                // If invite successful, then add to profiles table with admin role
                // The invited user will have a 'PENDING' status in auth.users until they click the invite link.
                // We'll insert into profiles here, they'll match up when they sign up.
                const { error: insertProfileError } = await supabase
                    .from('profiles')
                    .insert({ id: inviteData.user.id, email: newAdminEmail, role: 'admin' });

                if (insertProfileError) {
                    adminMessage.textContent = 'Gagal menyimpan profil admin baru: ' + insertProfileError.message;
                    adminMessage.classList.add('text-warm-red');
                    showToast('Gagal menyimpan profil admin: ' + insertProfileError.message, 'error');
                } else {
                    adminMessage.textContent = `Undangan admin ke ${newAdminEmail} berhasil dikirim! Pengguna perlu mengklik link di email untuk mendaftar.`;
                    adminMessage.classList.remove('text-warm-red');
                    adminMessage.classList.add('text-neon-green');
                    showToast('Undangan admin terkirim!', 'info');
                    document.getElementById('newAdminEmail').value = '';
                    loadUsers();
                }
            }
        }
    });

    // Initial data load and authentication check
    async function loadInitialData() {
        const { data: { user } } = await supabase.auth.getUser();
        if (user) {
            currentUserData = {
                id: user.id, // Ensure user ID is available
                email: user.email,
                displayName: user.user_metadata?.full_name || user.email.split('@')[0],
                photoURL: user.user_metadata?.avatar_url || `https://i.pravatar.cc/40?u=${user.email}`
            };

            document.getElementById('currentUserAvatar').src = currentUserData.photoURL;
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('appContainer').classList.remove('hidden');
            
            // Check if user is admin based on email
            if (user.email === 'radiansyahhanif@gmail.com') {
                localStorage.setItem('isAdmin', 'true');
                document.getElementById('adminNav').classList.remove('hidden');
                showSection('dashboardSection'); // Default to dashboard for admin
            } else {
                localStorage.setItem('isAdmin', 'false');
                document.getElementById('adminNav').classList.add('hidden'); // Hide admin nav for regular users
                showSection('dataEntrySection'); // Default to data entry for regular users
            }
            loadDashboardData();
            loadTransactions();
        } else {
            document.getElementById('appContainer').classList.add('hidden');
            document.getElementById('loginSection').style.display = 'flex';
        }
    }


    // Supabase Auth State Change Listener
    supabase.auth.onAuthStateChange((event, session) => {
      if (session?.user) {
        const user = session.user;
        currentUserData = {
          id: user.id, // Important: Store user ID
          email: user.email,
          displayName: user.user_metadata?.full_name || user.email.split('@')[0],
          photoURL: user.user_metadata?.avatar_url || `https://i.pravatar.cc/40?u=${user.email}`
        };
        
        // Update avatar
        document.getElementById('currentUserAvatar').src = currentUserData.photoURL;
        
        document.getElementById('loginSection').style.display = 'none';
        document.getElementById('appContainer').classList.remove('hidden');
        
        // Cek jika user adalah admin
        if (user.email === 'radiansyahhanif@gmail.com') {
          localStorage.setItem('isAdmin', 'true');
          document.getElementById('adminNav').classList.remove('hidden');
        } else {
          localStorage.setItem('isAdmin', 'false');
          document.getElementById('adminNav').classList.add('hidden');
        }
        
        // Initial load of data and setting default section based on role
        if (localStorage.getItem('isAdmin') === 'true') {
            showSection('dashboardSection');
        } else {
            showSection('dataEntrySection');
        }
        loadDashboardData();
        loadTransactions(); // Load transactions for current user/all
      } else {
        document.getElementById('appContainer').classList.add('hidden');
        document.getElementById('loginSection').style.display = 'flex';
        // Clear charts when logging out
        if (transactionsChart) transactionsChart.destroy();
        if (incomeExpenseChart) incomeExpenseChart.destroy();
      }
    });
    
    // Close dropdown menus when clicking outside
    document.addEventListener('click', function(e) {
      if (!e.target.closest('.dropdown')) {
        document.querySelectorAll('.dropdown-menu').forEach(menu => {
          menu.classList.add('hidden');
        });
      }
    });

    // Initialize application when the DOM is fully loaded
    document.addEventListener('DOMContentLoaded', () => {
        loadInitialData(); // This will check auth state and load data/UI accordingly
        
        // Avatar dropdown toggle
        document.getElementById('currentUserAvatar').addEventListener('click', function() {
            const dropdownMenu = this.closest('.dropdown').querySelector('.dropdown-menu');
            dropdownMenu.classList.toggle('hidden');
        });
    });
  </script>
</body>
</html>
