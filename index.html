<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>Kas QC Shift B</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    /* Animasi & helper classes */
    .float-animation { animation: float 4s infinite ease-in-out; }
    @keyframes float { 0%,100% {transform:translateY(0);}50%{transform:translateY(-10px);} }
    .fade-in { animation: fadeIn 0.3s ease-in; }
    @keyframes fadeIn { from{opacity:0;transform:translateY(10px);}to{opacity:1;} }
    .edit-form-textarea { width:100%; padding:.5rem; border:1px solid #ccc; border-radius:.5rem; margin-bottom:.5rem; }
  </style>
</head>
<body class="min-h-screen bg-gray-100 font-sans">

<!-- Loading Indicator -->
<div id="loading" class="hidden fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center z-50">
  <div class="loader ease-linear rounded-full border-4 border-blue-400 border-t-transparent h-12 w-12"></div>
</div>

<!-- Login -->
<section id="loginSection" class="min-h-screen flex items-center justify-center bg-gradient-to-br from-green-100 to-blue-200">
  <form id="loginForm" class="bg-white p-8 rounded-xl shadow-lg w-full max-w-md space-y-6 fade-in">
    <h2 class="text-center text-2xl font-bold text-blue-600">Masuk Kas QC Shift B</h2>
    <input id="emailInput" type="email" placeholder="Email" required class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-green-300">
    <input id="passwordInput" type="password" placeholder="Password" required class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-green-300">
    <button type="submit" class="w-full bg-green-400 hover:bg-green-500 text-white py-3 rounded-lg font-semibold">Masuk</button>
    <div class="text-right"><button type="button" onclick="showResetPasswordForm()" class="text-blue-500 hover:underline text-sm">Lupa password?</button></div>

    <!-- Reset -->
    <div id="resetContainer" class="hidden">
      <input id="resetEmailInput" type="email" placeholder="Email untuk reset" class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-green-300">
      <div class="flex gap-2">
        <button type="button" onclick="hideResetPasswordForm()" class="flex-1 bg-gray-200 text-gray-700 p-3 rounded-lg">Batal</button>
        <button type="button" onclick="sendResetPasswordLink()" class="flex-1 bg-blue-500 text-white p-3 rounded-lg">Kirim Link</button>
      </div>
    </div>
  </form>
</section>

<!-- Main -->
<div id="appContainer" class="hidden min-h-screen flex">
  <!-- Sidebar -->
  <aside class="w-64 bg-white/80 backdrop-blur-lg shadow-xl p-6 space-y-6">
    <div class="text-center">
      <div class="w-24 h-24 mx-auto rounded-full bg-green-300 float-animation flex items-center justify-center text-white text-4xl font-bold">QC</div>
      <h2 class="mt-2 font-bold text-xl text-blue-600">Tim QC Shift B</h2>
    </div>
    <nav class="space-y-2">
      <a href="#" class="nav-item block px-4 py-2 rounded hover:bg-green-200 active bg-green-200" onclick="showSection('dashboard', this)">Dashboard</a>
      <a href="#" class="nav-item block px-4 py-2 rounded hover:bg-green-200" onclick="showSection('agenda', this)">Agenda</a>
      <a href="#" class="nav-item block px-4 py-2 rounded hover:bg-green-200" onclick="showSection('team', this)">Tim</a>
      <a href="#" id="adminNav" class="nav-item hidden block px-4 py-2 rounded hover:bg-green-200" onclick="showSection('admin', this)">Admin Panel</a>
      <a href="#" class="nav-item block px-4 py-2 rounded hover:bg-green-200" onclick="showSection('whitepaper', this)">White Paper</a>
    </nav>
    <button onclick="supabase.auth.signOut()" class="w-full mt-8 bg-red-400 hover:bg-red-500 text-white py-2 rounded-lg"><i class="fas fa-sign-out-alt mr-2"></i>Logout</button>
  </aside>

  <!-- Content -->
  <main class="flex-1 overflow-y-auto p-8 space-y-8 bg-gray-50">
    <!-- Dashboard -->
    <section id="dashboard" class="fade-in">
      <h1 class="text-2xl font-bold text-blue-600 mb-6">Dashboard Kas</h1>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <div class="p-6 bg-blue-400 rounded-2xl text-white shadow-lg"><h3>Total Kas</h3><p id="totalKas" class="text-3xl font-bold mt-2">Rp 0</p></div>
        <div class="p-6 bg-green-300 rounded-2xl text-white shadow-lg"><h3>Kas Masuk</h3><p id="kasMasuk" class="text-3xl font-bold mt-2">Rp 0</p></div>
        <div class="p-6 bg-pink-300 rounded-2xl text-white shadow-lg"><h3>Kas Keluar</h3><p id="kasKeluar" class="text-3xl font-bold mt-2">Rp 0</p></div>
      </div>
      <canvas id="kasChart" class="bg-white rounded-2xl shadow-lg p-4 mt-6"></canvas>

      <!-- Social -->
      <div class="bg-white rounded-2xl shadow-lg p-6">
        <div class="flex items-start mb-4">
          <img id="currentUserAvatar" src="" class="w-10 h-10 rounded-full mr-3">
          <textarea id="postContent" class="flex-1 border rounded-lg p-3" placeholder="Apa yang ingin Anda sampaikan?"></textarea>
        </div>
        <div id="mediaPreview" class="mb-4"></div>
        <div class="flex justify-between mb-4">
          <div class="space-x-4"><button class="text-blue-500" onclick="openMediaPicker('image')"><i class="fas fa-image mr-1"></i>Foto</button><button class="text-green-600" onclick="openMediaPicker('video')"><i class="fas fa-video mr-1"></i>Video</button><button class="text-red-500" onclick="openMediaPicker('pdf')"><i class="fas fa-file-pdf mr-1"></i>PDF</button></div>
          <button onclick="createPost()" class="bg-pink-300 hover:bg-pink-400 text-white px-4 py-2 rounded-lg">Posting</button>
        </div>
        <div id="postFeed" class="space-y-4"></div>
      </div>
    </section>

    <!-- Agenda -->
    <section id="agenda" class="hidden fade-in">
      <h1 class="text-2xl font-bold text-blue-600 mb-6">Agenda Meeting</h1>
      <div id="agendaList" class="space-y-4"></div>
    </section>

    <!-- Tim -->
    <section id="team" class="hidden fade-in">
      <h1 class="text-2xl font-bold text-center text-blue-600 mb-6">Tim QC Shift B</h1>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div class="bg-white rounded-lg p-6 shadow text-center"><img class="w-24 h-24 rounded-full mx-auto mb-4" src="https://i.pravatar.cc/150?u=ramdhani"><p class="font-bold">Ramdhani</p><p class="text-blue-500">Koordinator</p></div>
        <div class="bg-white rounded-lg p-6 shadow text-center"><img class="w-24 h-24 rounded-full mx-auto mb-4" src="https://i.pravatar.cc/150?u=farhan"><p class="font-bold">Farhan Nasution</p><p class="text-blue-500">Anggota</p></div>
        <div class="bg-white rounded-lg p-6 shadow text-center"><img class="w-24 h-24 rounded-full mx-auto mb-4" src="https://i.pravatar.cc/150?u=wisnu"><p class="font-bold">Wisnu Putro</p><p class="text-blue-500">Anggota</p></div>
      </div>
    </section>

    <!-- Admin -->
    <section id="admin" class="hidden fade-in">
      <h1 class="text-2xl font-bold text-blue-600 mb-6">Admin Panel</h1>
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Form Transaksi -->
        <div class="bg-white rounded-2xl shadow-lg p-6">
          <h2 class="text-xl font-bold text-pink-300 mb-4">Input Transaksi</h2>
          <form id="formKas" class="space-y-4">
            <input type="hidden" id="editTransaksiId">
            <input type="date" id="tgl" class="w-full p-3 border rounded" required>
            <input type="text" id="ket" placeholder="Keterangan" class="w-full p-3 border rounded" required>
            <select id="tipe" class="w-full p-3 border rounded" required><option value="">--Jenis--</option><option value="Masuk">Masuk</option><option value="Keluar">Keluar</option></select>
            <input type="number" id="jml" placeholder="Jumlah" class="w-full p-3 border rounded" required>
            <div class="flex gap-2">
              <button type="submit" id="submitTransaksi" class="flex-1 bg-pink-300 text-white p-3 rounded-lg">Simpan</button>
              <button type="button" id="cancelEditTransaksi" onclick="cancelEditTransaksi()" class="flex-1 bg-gray-200 text-gray-700 p-3 rounded-lg hidden">Batal</button>
            </div>
          </form>
        </div>
        <!-- Form Agenda -->
        <div class="bg-white rounded-2xl shadow-lg p-6">
          <h2 class="text-xl font-bold text-green-300 mb-4">Input Agenda</h2>
          <form id="formAgenda" class="space-y-4">
            <input type="hidden" id="editAgendaId">
            <input type="text" id="agendaText" placeholder="Agenda" class="w-full p-3 border rounded" required>
            <input type="date" id="agendaDate" class="w-full p-3 border rounded" required>
            <input type="file" id="agendaImg" accept="image/*" class="w-full p-3 border rounded">
            <div id="currentImageContainer" class="hidden">
              <img id="currentImage" class="max-h-32 w-full mb-2">
              <button type="button" onclick="removeAgendaImage()" class="text-red-500 underline">Hapus Gambar</button>
            </div>
            <div class="flex gap-2">
              <button type="submit" id="submitAgenda" class="flex-1 bg-green-300 text-white p-3 rounded-lg">Simpan</button>
              <button type="button" id="cancelEditAgenda" onclick="cancelEditAgenda()" class="flex-1 bg-gray-200 text-gray-700 p-3 rounded-lg hidden">Batal</button>
            </div>
          </form>
        </div>
      </div>

      <!-- Daftar Transaksi -->
      <div class="bg-white rounded-2xl shadow-lg p-6">
        <div class="flex justify-between items-center mb-4"><h2 class="text-xl font-bold text-blue-600">Daftar Transaksi</h2><button onclick="exportToPDF()" class="bg-blue-400 text-white px-4 py-2 rounded-lg"><i class="fas fa-file-pdf mr-2"></i>Export PDF</button></div>
        <div class="overflow-x-auto"><table class="w-full text-sm"><thead class="bg-blue-500 text-white"><tr><th class="p-3">Tanggal</th><th class="p-3">Keterangan</th><th class="p-3">Tipe</th><th class="p-3 text-right">Jumlah</th><th class="p-3 text-center">Aksi</th></tr></thead><tbody id="logBody"></tbody></table></div>
      </div>
    </section>

    <!-- Whitepaper -->
    <section id="whitepaper" class="hidden fade-in"><h1 class="text-2xl font-bold text-blue-600 mb-6">White Paper</h1><div class="bg-white rounded-2xl shadow-lg p-6"><p class="text-gray-700">Dokumen kebijakan dan panduan akan ditampilkan di sini.</p></div></section>
  </main>
</div>
  
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
<script>
// ==== Supabase Setup ====
const supabase = supabase.createClient('https://aqlhsnkprwcxhqvizvyj.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFxbGhzbmtwcndjeGhxdml6dnlqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE5ODkzMDksImV4cCI6MjA2NzU2NTMwOX0.OKEP8UOnhhhbl3finjKkgybFeMFz09yEW_lxWnjoFCY');
let currentUserData = null, transactions = [], agendas = [], posts = [], mediaToUpload = null, kasChart = null;

  // === LOGIN FORM ===
  document.getElementById('loginForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    showLoading();

    const email = document.getElementById('emailInput').value.trim();
    const password = document.getElementById('passwordInput').value;

    const { error } = await supabase.auth.signInWithPassword({ email, password });
    hideLoading();

    if (error) {
      showNotification('Gagal login: ' + error.message, 'red');
    }
  });

  // === RESET PASSWORD ===
  function showResetPasswordForm() {
    document.getElementById('resetContainer').classList.remove('hidden');
  }

  function hideResetPasswordForm() {
    document.getElementById('resetContainer').classList.add('hidden');
  }

  async function sendResetPasswordLink() {
    const email = document.getElementById('resetEmailInput').value.trim();
    if (!email) return showNotification('Masukkan email', 'red');

    showLoading();
    const { error } = await supabase.auth.resetPasswordForEmail(email, {
      redirectTo: window.location.origin + '/index.html'
    });
    hideLoading();

    showNotification(error ? 'Gagal: ' + error.message : 'Link reset dikirim', error ? 'red' : 'green');
  }

  // === CEK SESI LOGIN SAAT HALAMAN DIBUKA ===
  supabase.auth.getSession().then(({ data: { session } }) => {
    if (session?.user) handleLogin(session.user);
  });

  // === PANTAU PERUBAHAN STATUS LOGIN ===
  supabase.auth.onAuthStateChange((event, session) => {
    if (session?.user) {
      handleLogin(session.user);
    } else {
      // Logout atau belum login
      document.getElementById('appContainer').classList.add('hidden');
      document.getElementById('loginSection').style.display = 'flex';
    }
  });

  // === TAMPILKAN DATA USER DAN UI ===
  function handleLogin(user) {
    const loginSec = document.getElementById('loginSection');
    const app = document.getElementById('appContainer');
    const adminNav = document.getElementById('adminNav');

    currentUserData = {
      email: user.email,
      displayName: user.user_metadata?.full_name || user.email.split('@')[0],
      photoURL: user.user_metadata?.avatar_url || `https://i.pravatar.cc/40?u=${user.email}`
    };

    document.querySelectorAll('#currentUserAvatar').forEach(el => el.src = currentUserData.photoURL);
    loginSec.style.display = 'none';
    app.classList.remove('hidden');

    const isAdmin = user.email === 'radiansyahhanif@gmail.com';
    localStorage.setItem('isAdmin', isAdmin);
    isAdmin ? adminNav.classList.remove('hidden') : adminNav.classList.add('hidden');

    showSection('dashboard');
    loadDashboard();
    loadTransactions();
    loadAgendas();
  }

// ==== Navigation ====
function showSection(id, el) {
  document.querySelectorAll('.nav-item').forEach(x=>x.classList.remove('active'));
  if(el) el.classList.add('active');
  ['dashboard','agenda','team','admin','whitepaper'].forEach(s=>document.getElementById(s).classList.add('hidden'));
  document.getElementById(id).classList.remove('hidden');
}

// ==== Dashboard: Chart & Social ====
async function loadDashboard() {
  showLoading();
  let { data:tx, error:te }=await supabase.from('transactions').select('*').order('tgl',{ascending:true});
  if(te){hideLoading();return showNotification('Load txn error','red')}
  transactions=tx; updateDashboard();

  let { data:ps, error:pe }=await supabase.from('posts').select('*,comments(*)').order('created_at', {ascending:false});
  hideLoading();
  if(pe) return showNotification('Load post error','red');
  posts=ps; renderPosts();
}

function updateDashboard(){
  const masuk=transactions.filter(t=>t.tipe==='Masuk').reduce((a,b)=>a+b.jml,0),
        keluar=transactions.filter(t=>t.tipe==='Keluar').reduce((a,b)=>a+b.jml,0);
  document.getElementById('kasMasuk').textContent=formatRupiah(masuk);
  document.getElementById('kasKeluar').textContent=formatRupiah(keluar);
  document.getElementById('totalKas').textContent=formatRupiah(masuk-keluar);
  renderChart();
}

function renderChart(){
  const ctx=document.getElementById('kasChart').getContext('2d');
  if(kasChart) kasChart.destroy();
  const labels=transactions.map(t=>t.tgl),
        dataMasuk=transactions.map(t=>t.tipe=='Masuk'?t.jml:0),
        dataKeluar=transactions.map(t=>t.tipe=='Keluar'?t.jml:0);
  kasChart=new Chart(ctx,{type:'bar',data:{labels, datasets:[{label:'Masuk',data:dataMasuk,backgroundColor:'#a2e4b8'},{label:'Keluar',data:dataKeluar,backgroundColor:'#ffb7b2'}]}});
}

function openMediaPicker(type){
  const input=document.createElement('input');input.type='file';
  if(type==='image') input.accept='image/*'; if(type==='video') input.accept='video/*'; if(type==='pdf') input.accept='.pdf';
  input.onchange=e=>{
    const f=e.target.files[0];if(!f)return;
    mediaToUpload=f;const p=document.getElementById('mediaPreview');p.innerHTML='';
    const rdr=new FileReader();rdr.onload=()=>{if(f.type.startsWith('image')) p.innerHTML=`<img src="${rdr.result}" class="max-h-40 rounded-lg">`;else if(f.type.startsWith('video')){const url=URL.createObjectURL(f); p.innerHTML=`<video controls src="${url}" class="max-h-40 rounded-lg">`;}};
    rdr.readAsDataURL(f);
  };input.click();
}

async function createPost(){
  const cont=document.getElementById('postContent').value.trim();
  if(!cont) return showNotification('Isi konten','red');
  showLoading();
  const { data:{ user } } = await supabase.auth.getUser();
  const newPost={content:cont,author:user.email,author_name:currentUserData.displayName,likes:0};
  if(mediaToUpload){
    const path=`posts/${user.id}/${Date.now()}_${mediaToUpload.name}`;
    const { error:ue }=await supabase.storage.from('posts').upload(path,mediaToUpload);
    if(ue){hideLoading();return showNotification('Upload gagal','red')}
    const { data:{ publicUrl } }=supabase.storage.from('posts').getPublicUrl(path);
    if(mediaToUpload.type.startsWith('image')) newPost.image_url=publicUrl;
    if(mediaToUpload.type.startsWith('video')) newPost.video_url=publicUrl;
    mediaToUpload=null;document.getElementById('mediaPreview').innerHTML='';
  }
  const { error:pe }=await supabase.from('posts').insert(newPost);
  hideLoading();
  if(pe) return showNotification('Gagal post','red');
  document.getElementById('postContent').value='';
  loadDashboard();
  showNotification('Posting berhasil','green');
}

function renderPosts(){
  const feed=document.getElementById('postFeed');feed.innerHTML='';
  posts.forEach(p=>{
    const div=document.createElement('div');div.className='post bg-white p-4 rounded-lg shadow-lg';
    const timeAgo=formatRelativeTime(new Date(p.created_at).getTime());
    const isAuthor=currentUserData?.email===p.author;
    const commentsCount=p.comments?.length||0;
    div.innerHTML=`
      <div class="flex justify-between items-start mb-3">
        <div class="flex items-center">
          <img src="https://i.pravatar.cc/40?u=${p.author}" class="w-10 h-10 rounded-full mr-3">
          <div><h4 class="font-bold">${p.author_name}</h4><p class="text-xs text-gray-500">${timeAgo}</p></div>
        </div>
        ${isAuthor?`<button onclick="deletePost('${p.id}')" class="text-red-500 text-sm">Hapus</button>`:``}
      </div>
      <p class="mb-3">${p.content}</p>
      ${p.image_url?`<img src="${p.image_url}" class="rounded-lg mb-3 max-h-96 w-full object-contain border">`:''}
      ${p.video_url?`<video controls src="${p.video_url}" class="rounded-lg mb-3 max-h-96 w-full border">`: ''}
      <div class="flex gap-4 text-gray-600 text-sm border-t border-b py-2 my-2">
        <button onclick="likePost('${p.id}')" class="flex items-center gap-1"><i class="fas fa-thumbs-up"></i><span id="likeCount-${p.id}">${p.likes}</span></button>
        <button onclick="toggleComments('${p.id}')" class="flex items-center gap-1"><i class="fas fa-comment"></i>${commentsCount}</button>
      </div>
      <div id="comments-${p.id}" class="hidden mt-3">
        <div class="flex mb-3">
          <input type="text" id="commentInput-${p.id}" placeholder="Komentar..." class="flex-1 border rounded-l-lg px-3 py-2">
          <button onclick="addComment('${p.id}')" class="bg-blue-500 text-white px-3 py-2 rounded-r-lg">Kirim</button>
        </div>
        <div id="commentList-${p.id}" class="space-y-2">
          ${p.comments?.map(c=>`
            <div class="flex items-start"><img src="https://i.pravatar.cc/30?u=${c.user_id}" class="w-6 h-6 rounded-full mr-2"><div class="bg-gray-100 rounded-lg px-3 py-2 flex-1"><p class="font-medium text-sm">${c.author_name}</p><p class="text-gray-700 text-sm">${c.text}</p><p class="text-gray-500 text-xs">${formatRelativeTime(c.timestamp)}</p></div></div>
          `).join('')}
        </div>
      </div>
      <div id="editForm-${p.id}" class="hidden mt-3"><textarea id="editContent-${p.id}" class="edit-form-textarea">${p.content}</textarea><div class="flex justify-end gap-2"><button onclick="cancelEdit('${p.id}')" class="px-3 py-1 bg-gray-200 rounded">Batal</button><button onclick="saveEdit('${p.id}')" class="px-3 py-1 bg-blue-500 text-white rounded">Simpan</button></div></div>
    `;
    feed.appendChild(div);
  });
}

async function likePost(id){
  const { data:{ user } } = await supabase.auth.getUser();
  if(!user) return showNotification('Login dulu','red');
  await supabase.from('post_likes').insert({ post_id: id, user_id: user.id });
  await supabase.from('posts').update({ likes: supabase.raw('likes+1') }).eq('id', id);
  loadDashboard();
}
async function addComment(id){
  const { data:{ user } } = await supabase.auth.getUser();
  const inp=document.getElementById(`commentInput-${id}`);
  if(!inp.value.trim()) return;
  await supabase.from('comments').insert({ post_id: id, user_id: user.id, author_name: currentUserData.displayName, text: inp.value.trim(), timestamp: Date.now() });
  loadDashboard();
}
function toggleComments(id){document.getElementById(`comments-${id}`).classList.toggle('hidden');}
function cancelEdit(id){document.getElementById(`editForm-${id}`).classList.add('hidden');}
async function saveEdit(id){
  const val=document.getElementById(`editContent-${id}`).value.trim();
  if(!val) return showNotification('Tidak boleh kosong','red');
  await supabase.from('posts').update({content:val}).eq('id',id);
  loadDashboard();
}
async function deletePost(id){
  if(!confirm('Hapus postingan?'))return;
  await supabase.from('posts').delete().eq('id',id);
  loadDashboard();
}

// ==== Admin: Transaksi & Agenda ====
document.getElementById('formKas').addEventListener('submit', async e=>{
  e.preventDefault();
  const id=document.getElementById('editTransaksiId').value;
  const obj={ tgl:document.getElementById('tgl').value, ket:document.getElementById('ket').value, tipe:document.getElementById('tipe').value, jml: Number(document.getElementById('jml').value) };
  if(id) await supabase.from('transactions').update(obj).eq('id', id);
  else await supabase.from('transactions').insert(obj);
  resetKasForm(); loadDashboard(); loadTransactions();
});
async function loadTransactions(){
  const { data, error } = await supabase.from('transactions').select('*').order('tgl',{ascending:false});
  if(error) return showNotification('Load transaksi gagal','red');
  transactions = data; updateTransactionsTable();
}
function updateTransactionsTable(){
  const body=document.getElementById('logBody');
  body.innerHTML='';
  const isAdmin=localStorage.getItem('isAdmin')==='true';
  transactions.forEach(t=>{
    const row=document.createElement('tr');row.className='hover:bg-gray-50';
    row.innerHTML=`
      <td class="p-3">${formatDate(t.tgl)}</td><td class="p-3">${t.ket}</td><td class="p-3 ${t.tipe=='Masuk'?'text-green-500':'text-red-500'}">${t.tipe}</td><td class="p-3 text-right">${formatRupiah(t.jml)}</td><td class="p-3 text-center">${isAdmin?`<button onclick="editKas('${t.id}')" class="px-2 py-1 bg-yellow-400 text-white rounded mr-1">Edit</button><button onclick="deleteKas('${t.id}')" class="px-2 py-1 bg-red-400 text-white rounded">Hapus</button>`:'-'}</td>`;
    body.appendChild(row);
  });
}
function editKas(id){
  const t=transactions.find(x=>x.id===id);
  document.getElementById('tgl').value=t.tgl; document.getElementById('ket').value=t.ket;
  document.getElementById('tipe').value=t.tipe; document.getElementById('jml').value=t.jml;
  document.getElementById('editTransaksiId').value=id;
  document.getElementById('submitTransaksi').textContent='Update';
  document.getElementById('cancelEditTransaksi').classList.remove('hidden');
}
async function deleteKas(id){if(confirm('Yakin hapus?')){await supabase.from('transactions').delete().eq('id',id); loadDashboard(); loadTransactions();}}
function cancelEditTransaksi(){resetKasForm();}
function resetKasForm(){
  document.getElementById('formKas').reset();
  document.getElementById('editTransaksiId').value='';
  document.getElementById('submitTransaksi').textContent='Simpan';
  document.getElementById('cancelEditTransaksi').classList.add('hidden');
}

// ==== Agenda ====
document.getElementById('formAgenda').addEventListener('submit', async e=>{
  e.preventDefault();
  const id=document.getElementById('editAgendaId').value;
  const data={ text:document.getElementById('agendaText').value, date:document.getElementById('agendaDate').value };
  if(id) await supabase.from('agendas').update(data).eq('id',id);
  else await supabase.from('agendas').insert(data);
  resetAgendaForm(); loadAgendas();
});
async function loadAgendas(){
  const { data, error } = await supabase.from('agendas').select('*').order('date',{ascending:true});
  if(error) return showNotification('Load agenda gagal','red');
  agendas=data; renderAgendas();
}
function renderAgendas(){
  const list=document.getElementById('agendaList'); list.innerHTML='';
  const isAdmin=localStorage.getItem('isAdmin')==='true';
  agendas.forEach(a=>{
    const div=document.createElement('div'); div.className='bg-white p-4 rounded-lg shadow flex justify-between items-center';
    div.innerHTML=`<div><h3 class="font-bold text-blue-600">${a.text}</h3><p class="text-sm text-gray-500">${formatDate(a.date)}</p></div>
      ${isAdmin?`<div class="flex gap-2"><button onclick="editAgenda('${a.id}')" class="text-green-500"><i class="fas fa-edit"></i></button><button onclick="deleteAgenda('${a.id}')" class="text-red-500"><i class="fas fa-trash"></i></button></div>`:''}`;
    list.appendChild(div);
  });
}
function editAgenda(id){
  const a=agendas.find(x=>x.id===id);
  document.getElementById('agendaText').value=a.text; document.getElementById('agendaDate').value=a.date;
  document.getElementById('editAgendaId').value=id;
  document.getElementById('submitAgenda').textContent='Update';
  document.getElementById('cancelEditAgenda').classList.remove('hidden');
}
async function deleteAgenda(id){if(confirm('Yakin hapus agenda?')){await supabase.from('agendas').delete().eq('id',id); loadAgendas();}}
function cancelEditAgenda(){resetAgendaForm();}
function resetAgendaForm(){
  document.getElementById('formAgenda').reset();
  document.getElementById('editAgendaId').value='';
  document.getElementById('submitAgenda').textContent='Simpan';
  document.getElementById('cancelEditAgenda').classList.add('hidden');
}

// ==== Utils ====
function formatRupiah(x) {return 'Rp '+Number(x).toLocaleString('id-ID');}
function formatDate(d) {
  const dt=new Date(d);
  return dt.toLocaleDateString('id-ID',{day:'2-digit',month:'long',year:'numeric'});
}
function formatRelativeTime(t){
  const diff=Date.now()-t, minute=60000, hour=3600000, day=86400000;
  return diff<minute?'Baru saja':diff<hour?`${Math.floor(diff/minute)} menit yang lalu`:diff<day?`${Math.floor(diff/hour)} jam yang lalu`:`${Math.floor(diff/day)} hari yang lalu`;
}

function showNotification(msg,type='blue'){
  const el=document.createElement('div');
  el.className=`fixed top-4 right-4 px-4 py-2 rounded shadow text-white ${type==='green'?'bg-green-500':type==='red'?'bg-red-500':'bg-blue-500'}`;
  el.textContent=msg; document.body.appendChild(el);
  setTimeout(()=>el.remove(),3000);
}

function showLoading(){document.getElementById('loading').classList.remove('hidden');}
function hideLoading(){document.getElementById('loading').classList.add('hidden');}

function exportToPDF(){alert('Implement PDF export pakai jsPDF');}
</script>
</body>
</html>
